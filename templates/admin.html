{% extends "base.html" %}

{% block title %}Token管理{% endblock %}

{% block extra_css %}
<style>
    .CodeMirror {
        height: 400px;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
    }

    button:disabled {
        color: #ccc;
        background-color: #eee;
        border: none;
        cursor: not-allowed;
    }

    button:disabled:hover {
        color: #ccc;
        background-color: #eee;
        border: none;
        cursor: not-allowed;
    }
</style>
{% endblock %}
{% block content %}

<div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
    <textarea id="jsonTextarea" class="hidden">{{ retokens | tojson(indent=2) }}</textarea>
    <div class="flex items-center justify-between mt-4">
        <div>
            <button id="saveBtn"
                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300 ease-in-out mr-2">
                保存
            </button>
            <button id="formatBtn"
                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300 ease-in-out mr-2">
                格式化
            </button>
            <button id="refreshBtn"
                class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300 ease-in-out mr-2">
                立即刷新 Tokens
            </button>
        </div>
        <p id="statusMessage" class="italic"></p>
    </div>
</div>

<div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">自动刷新设置</h2>
    <div class="flex items-center mb-4">
        <input type="checkbox" id="autoRefreshToggle" class="mr-2">
        <label for="autoRefreshToggle" class="mr-4">启用自动刷新</label>
        <input type="number" id="refreshInterval" min="1" value="1" class="border rounded px-2 py-1 w-20 mr-2">
        <span>天</span>
    </div>
    <p id="nextRefreshTime" class="text-gray-600"></p>
</div>

<div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">失败的 Refresh Token</h2>
    <details class="mb-4">
        <summary class="cursor-pointer text-blue-600 hover:text-blue-800">点击查看失败的 Refresh Token</summary>
        <div id="failedTokens" class="mt-2 space-y-1">
            <!-- 失败的 tokens 将在这里动态添加 -->
        </div>
    </details>
</div>

<div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">刷新历史</h2>
    <div id="refreshHistory" class="space-y-2">
        <!-- 刷新历史将在这里动态添加 -->
    </div>
</div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const textarea = document.getElementById('jsonTextarea');
        const editor = CodeMirror.fromTextArea(textarea, {
            lineNumbers: true,
            mode: { name: "javascript", json: true },
            theme: "default",
            matchBrackets: true,
            autoCloseBrackets: true,
            indentUnit: 2,
            tabSize: 2,
        });

        const saveBtn = document.getElementById('saveBtn');
        const formatBtn = document.getElementById('formatBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const statusMessage = document.getElementById('statusMessage');
        const autoRefreshToggle = document.getElementById('autoRefreshToggle');
        const refreshInterval = document.getElementById('refreshInterval');
        const nextRefreshTime = document.getElementById('nextRefreshTime');
        const refreshHistory = document.getElementById('refreshHistory');

        function loadFailedTokens() {
            fetch('/get_failed_tokens')
                .then(response => response.json())
                .then(data => {
                    const failedTokensDiv = document.getElementById('failedTokens');
                    failedTokensDiv.innerHTML = '';  // 清空现有内容
                    data.forEach(item => {
                        const email = Object.keys(item)[0];
                        const tokenItem = document.createElement('div');
                        tokenItem.className = 'bg-red-100 p-2 rounded';
                        tokenItem.textContent = email;
                        failedTokensDiv.appendChild(tokenItem);
                    });
                })
                .catch(error => {
                    console.error('加载失败Refresh Token 失败:', error);
                    showStatus('加载失败的 Tokens 失败', 'error');
                });
        }


        function updateAutoRefreshUI(config) {
            autoRefreshToggle.checked = config.auto_refresh_enabled;
            refreshInterval.value = config.refresh_interval_days;
            if (config.next_refresh_time) {
                nextRefreshTime.textContent = `下次刷新时间: ${new Date(config.next_refresh_time).toLocaleString()}`;
            } else {
                nextRefreshTime.textContent = '自动刷新已关闭';
            }
        }

        function loadAutoRefreshConfig() {
            fetch('/get_auto_refresh_config')
                .then(response => response.json())
                .then(config => {
                    updateAutoRefreshUI(config);
                })
                .catch(error => {
                    console.error('加载自动刷新配置失败:', error);
                    showStatus('加载自动刷新配置失败', 'error');
                });
        }

        function saveAutoRefreshConfig() {
            fetch('/set_auto_refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    enabled: autoRefreshToggle.checked,
                    interval: parseInt(refreshInterval.value)
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showStatus('自动刷新设置已更新', 'success');
                        loadAutoRefreshConfig();
                    } else {
                        showStatus('更新自动刷新设置失败', 'error');
                    }
                })
                .catch(error => {
                    showStatus('更新自动刷新设置失败', 'error');
                });
        }

        autoRefreshToggle.addEventListener('change', saveAutoRefreshConfig);
        refreshInterval.addEventListener('change', saveAutoRefreshConfig);

        function refreshTokens() {
            refreshBtn.disabled = true
            fetch('/refresh_tokens', {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        refreshBtn.disabled = false
                        showStatus('Tokens 刷新成功', 'success');
                        // editor.setValue(JSON.stringify(data.access_tokens, null, 2));
                        loadRefreshHistory();
                        loadAutoRefreshConfig();  // 刷新后更新自动刷新配置
                        loadFailedTokens();
                    } else {
                        refreshBtn.disabled = false
                        showStatus('Tokens 刷新失败: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    refreshBtn.disabled = false
                    showStatus('Tokens 刷新失败', error);
                });
        }

        function loadRefreshHistory() {
            fetch('/refresh_history')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        refreshHistory.innerHTML = '';  // 清空现有历史
                        data.history.forEach(item => {
                            const historyItem = document.createElement('div');
                            historyItem.className = 'bg-gray-100 p-2 rounded';
                            historyItem.innerHTML = `
                        <p><strong>刷新时间:</strong> ${new Date(item.timestamp).toLocaleString()}</p>
                        <p><strong>Token 数量:</strong> ${item.token_count}</p>
                    `;
                            refreshHistory.appendChild(historyItem);
                        });
                    }
                })
                .catch(error => {
                    console.error('加载刷新历史失败:', error);
                    showStatus('加载刷新历史失败', 'error');
                });
        }

        saveBtn.addEventListener('click', function () {
            let updatedRetokens;
            try {
                updatedRetokens = JSON.parse(editor.getValue());
            } catch (e) {
                showStatus('JSON 格式错误！', 'error');
                return;
            }

            fetch('/admin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ retokens: updatedRetokens })
            })
                .then(response => response.json())
                .then(data => {
                    showStatus(data.message, data.status);
                })
                .catch(error => {
                    showStatus('更新失败！', 'error');
                });
        });

        formatBtn.addEventListener('click', function () {
            try {
                const json = JSON.parse(editor.getValue());
                editor.setValue(JSON.stringify(json, null, 2));
                showStatus('JSON 已格式化', 'success');
            } catch (e) {
                showStatus('JSON 格式错误，无法格式化', 'error');
            }
        });

        refreshBtn.addEventListener('click', refreshTokens);

        function showStatus(message, status) {
            statusMessage.textContent = message;
            statusMessage.className = status === 'success' ? 'text-green-600' : 'text-red-600';
            setTimeout(() => {
                statusMessage.textContent = '';
            }, 3000);
        }

        // 初始化：加载自动刷新配置和刷新历史、失败的retoken
        loadAutoRefreshConfig();
        loadRefreshHistory();
        loadFailedTokens();
    });
</script>
{% endblock %}